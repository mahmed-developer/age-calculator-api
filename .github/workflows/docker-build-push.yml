name: CI/CD Pipeline - Build & Push Docker Image

# Trigger on push to main branch (or tags for releases)
on:
  push:
    branches: [ main ]

# Environment variables (shared across jobs)
env:
  REGISTRY: docker.io
  IMAGE_NAME: mahmeddev/age-api  # Your Docker Hub repo/image name
  IMAGE_TAG: ${{ github.sha }}   # Unique tag from commit hash

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # Free GitHub runner (like a clean EC2)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # Pulls your repo code

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'  # Matches your Dockerfile

    - name: Lint Python code (optional quality check)
      run: |
        pip install flake8
        flake8 app.py  # Fails if code style issues

    - name: Build Docker image
      run: |
        docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
        docker build -t $REGISTRY/$IMAGE_NAME:latest .  # Also tag as 'latest'

    - name: Test Docker image
      run: |
        # Run container and test endpoints
        docker run -d -p 5000:5000 --name test-container $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
        sleep 5  # Wait for startup
        curl --fail http://localhost:5000 || exit 1  # Test home route
        curl --fail "http://localhost:5000/calculate?name=Test&age=30" || exit 1  # Test API
        docker stop test-container && docker rm test-container

    - name: Login to Docker Hub
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'  # Only on main push
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Docker image
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      run: |
        docker push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
        docker push $REGISTRY/$IMAGE_NAME:latest

    - name: Update README with latest image tag (optional)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Latest image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG" >> README.md
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add README.md
        git commit -m "Update README with latest image tag" || echo "No changes"
        git push
